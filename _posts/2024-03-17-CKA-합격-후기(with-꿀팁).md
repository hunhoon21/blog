ì•ˆë…•í•˜ì„¸ìš”, ìµœê·¼(3ì›” 19ì¼) CKA(Certified Kubernetes Administrator) ì‹œí—˜ì— ì‘ì‹œí•˜ì—¬ í•©ê²©í–ˆìŠµë‹ˆë‹¤.
ì‘ì‹œ í›„ê¸°ì™€ ì¤€ë¹„í•˜ë©´ì„œ ì–»ê²Œ ëœ ê¿€íŒì„ ê³µìœ í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

> <img src="https://github.com/hunhoon21/hunhoon21.github.io/assets/36983960/c7780e13-ad06-4072-a187-7e0d5ff8f43f" alt="CKA" width="100%"/>

* [CKA ë€?](#CKA-ë€?)
* [ì‹œí—˜ ì¤€ë¹„ ê³¼ì •ê³¼ í•©ê²© í›„ê¸°](#ì‹œí—˜-ì¤€ë¹„-ê³¼ì •ê³¼-í•©ê²©-í›„ê¸°)
  * [ì‹œí—˜ ì¤€ë¹„ ê³¼ì •](#ì‹œí—˜-ì¤€ë¹„-ê³¼ì •)
  * [í•©ê²© í›„ê¸°](#í•©ê²©-í›„ê¸°)
* [ê¿€íŒ](#ê¿€íŒ)
* [ê²°ë¡ ](#ê²°ë¡ )
* [ë¬¸ì œ ìœ í˜•ê³¼ ì •ë¦¬ ë…¸íŠ¸ ê³µìœ ](#ë¬¸ì œ-ìœ í˜•ê³¼-ì •ë¦¬-ë…¸íŠ¸-ê³µìœ )

## CKA ë€?

CKA(Certified Kubernetes Administrator) ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ ì¼ìƒì ì¸ ìš´ì˜ê³¼ ê´€ë¦¬ì— í•„ìš”í•œ ì‹¤ì§ˆì ì¸ ëŠ¥ë ¥ì„ ì¸ì¦í•˜ëŠ” ìê²©ì¦ì…ë‹ˆë‹¤. Cloud Native Computing Foundation(CNCF)ê³¼ Linux Foundationì´ ê³µë™ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì¸ì¦ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. CKA ì‹œí—˜ì€ Kubernetesê°€ ì„¤ì¹˜ ë˜ì–´ìˆëŠ” í™˜ê²½ì—ì„œ ì‹¤ì œ ë¬¸ì œë“¤ì„ í•´ê²°í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ë¥¼ ìœ„í•œ íŒŸ(Pod)ì„ ìƒì„±í•˜ê±°ë‚˜ ë³¼ë¥¨(Volume) ì„ ë§Œë“¤ì–´ì„œ Mount í•˜ëŠ” ë¬¸ì œê°€ ì£¼ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜, íŠ¸ëŸ¬ë¸” ìŠˆíŒ…í•˜ëŠ” ë¬¸ì œë„ ë‚˜ì˜µë‹ˆë‹¤.

## ì‹œí—˜ ì¤€ë¹„ ê³¼ì •ê³¼ í•©ê²© í›„ê¸°

ì €ëŠ” ì—…ë¬´ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ í™œìš©í•˜ê³  ìˆì—ˆìœ¼ë¯€ë¡œ ì‹œí—˜ì„ ì¤€ë¹„í•˜ëŠ”ë° ë„ì›€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ì‹¤ ìê²©ì¦ ì·¨ë“ì„ ëª©í‘œë¡œ í•œ ê²ƒì€ ê±°ì˜ 2ë…„ì „ì´ì˜€ìœ¼ë‚˜ ê³„ì† ë¯¸ë£¨ë‹¤ê°€ ìµœê·¼ì— ì·¨ë“í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ëŠ” 2022ë…„ 11ì›”ê²½ ë¸”ë™ í”„ë¼ì´ë°ì´ì— ì‹œí—˜ì„ êµ¬ë§¤í•˜ì˜€ê³ , 2024ë…„ 2ì›” ë§ë¶€í„° ì¤€ë¹„í•´ì„œ ê±°ì˜ 2ì£¼ë§Œì— ì·¨ë“í•˜ì˜€ìŠµë‹ˆë‹¤. (ì‹œí—˜ ë§Œë£Œê°€ ì–¼ë§ˆ ì•ˆ ë‚¨ì•˜ì—ˆê±°ë“ ìš”.) ì—­ì‹œ ì‹œí—˜ ì¼ì •ì„ ë¨¼ì € ì •í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤ ğŸ˜‚ 

### ì‹œí—˜ ì¤€ë¹„ ê³¼ì •

ì¿ ë²„ë„¤í‹°ìŠ¤ì— ëŒ€í•œ ê°œë…ì€ ì–´ëŠì •ë„ ì•Œê³  ìˆì—ˆìœ¼ë¯€ë¡œ ë°”ë¡œ ë¬¸ì œ í’€ì´ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” [ë”°ë°°ì”¨(ë”°ë¼í•˜ë©´ì„œ ë°°ìš°ëŠ” CKA)](https://www.youtube.com/watch?v=KdATmTulf7s&list=PLApuRlvrZKojqx9-wIvWP3MPtgy2B372f&ab_channel=TTABAE-LEARN) ê³¼ì •ì„ ìˆ˜ê°•í•˜ë©´ì„œ ì‹œí—˜ì„ ì¤€ë¹„í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ë¬¸ì œ ìœ í˜•ë“¤ì„ íŒŒì•…í•˜ê³ , ì°¸ê³ í• ë§Œ í•œ ê³µì‹ë¬¸ì„œ ê²€ìƒ‰ í‚¤ì›Œë“œë“¤ì„ ì°¸ê³ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ë“£ê¸°ë§Œ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì˜ìƒ ì´ˆë°˜ì˜ ë¬¸ì œë¥¼ ë³´ê³  ìŠ¤ìŠ¤ë¡œ ê³µì‹ ë¬¸ì„œì—ì„œ ê²€ìƒ‰í•˜ë©° ì§ì ‘ í’€ì–´ë³´ê³ , ê¸°ë¡í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì—°ìŠµí–ˆìŠµë‹ˆë‹¤. ì•„ë˜ëŠ” deployment ì˜ ì´ë¯¸ì§€ ë²„ì „ì„ ì—…ë°ì´íŠ¸í•˜ê³  ë¡¤ë°±í•˜ëŠ” ë¬¸ì œë¥¼ ì—°ìŠµí•œ ê¸°ë¡ì…ë‹ˆë‹¤.

```
# 7. Rolling update & Roll Back
# https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment
# https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-a-deployment
k create deployment nginx-app --image=nginx:1.11.10-alpine --replicas=3 --dry-run=client -o yaml
k create deployment nginx-app --image=nginx:1.11.10-alpine --replicas=3

# update
kubectl set image deployment.v1.apps/nginx-app nginx=nginx:1.11.13-alpine --record

# rollback
kubectl rollout history deployment/nginx-app
kubectl rollout undo deployment/nginx-app
```

ì–´ëŠ ì •ë„ ë¬¸ì œì— ìµìˆ™í•´ì§€ê³  ë‚˜ì„œëŠ” ì‹¤ì œ í™˜ê²½ì—ì„œ ì§ì ‘ í’€ì–´ë³´ëŠ” ì—°ìŠµì„ í–ˆìŠµë‹ˆë‹¤. CKA ì‹œí—˜ì„ êµ¬ë§¤í–ˆë‹¤ë©´ [killer.sh](https://killer.sh/) í˜ì´ì§€ì—ì„œ ì‹œë®¬ë ˆì´í„°ë¥¼ í†µí•´ ì‹œí—˜ í™˜ê²½ê³¼ ë™ì¼í•œ í™˜ê²½ì—ì„œ ì§ì ‘ ë¬¸ì œë“¤ì„ í’€ì–´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ ë³µì‚¬/ë¶™ì—¬ë„£ê¸°ì™€ ê°™ì€ ì‘ì—…ë„ ë¨¼ì € í•´ë³´ëŠ” ê²ƒì´ ì‹œí—˜ ì‘ì‹œí•˜ëŠ”ë° ë¬´ì²™ ì¤‘ìš”í–ˆìŠµë‹ˆë‹¤. ë˜í•œ ë¬¸ì œë“¤ì„ ì§ì ‘ í’€ì–´ë³¼ ìˆ˜ ìˆì–´ì„œ ì¤€ë¹„í•˜ëŠ”ë° í° ë„ì›€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. `killer.sh` ì€ ë‘ë²ˆê¹Œì§€ ì‹œë®¬ë ˆì´í„°ë¥¼ ì‚¬ìš©í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### í•©ê²© í›„ê¸°

ì‹œí—˜ ì‹œê°„ì€ 2ì‹œê°„ì´ê³ , 17 ë¬¸ì œê°€ ì£¼ì–´ì§‘ë‹ˆë‹¤. ìƒê°ë³´ë‹¤ ì‹œí—˜ ì‹œê°„ì´ ì´‰ë°•í•˜ê²Œ ëŠê»´ì¡ŒìŠµë‹ˆë‹¤. ì‹œí—˜ ì‘ì‹œ ì „ì— ê¹ê¹í•˜ê²Œ ê°ë…ê´€ì´ ì‹œí—˜ í™˜ê²½(ì±…ìƒ ìœ„ ë“± ë°©ì˜ í™˜ê²½)ì„ ê²€ì‚¬í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ ì´ ë•Œ ë©˜íƒˆì´ ì˜ ë¶™ì¡ì•„ì•¼ í•©ë‹ˆë‹¤. ë‹¹í™©í•´ì„œ  ë’¤ì— ì´ì–´ì§€ëŠ” ì‹œí—˜ê¹Œì§€ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ `killer.sh` ì„ ë¨¼ì € ë“¤ì–´ê°€ë³´ì§€ ì•Šì•˜ë‹¤ë©´ ë¬´ì²™ ë‹¹í™©í–ˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì‹œí—˜ í™˜ê²½ì€ ë³¸ì¸ì˜ ë¸Œë¼ìš°ì €ì™€ ë‹¤ë¥¸ í™˜ê²½ì´ê¸° ë•Œë¬¸ì— ì‹œë®¬ë ˆì´í„°ì—ì„œ ì§ì ‘ ê·¸ í™˜ê²½ì„ ë¯¸ë¦¬ ê²½í—˜í•˜ëŠ” ê²ƒì´ í° ë„ì›€ì´ ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë³´í†µ í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê²€ìƒ‰ì°½ì´ ìš°ì¸¡ ìƒë‹¨ì— ëœ¨ëŠ”ë° ì‹œí—˜ í™˜ê²½ì˜ íŒŒì´ì–´í­ìŠ¤ëŠ” ì¢Œì¸¡ í•˜ë‹¨ì— ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ë‹¤ë¥¸ ì ì„ ë¯¸ë¦¬ ê²½í—˜í•´ì•¼ ì‹œí—˜ ë•Œ ì¤€ë¹„í•œëŒ€ë¡œ ë¬¸ì œë¥¼ í’€ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¬¸ì œê°€ ì§€ì–´ì§€ë©´ ê³µì‹ ë¬¸ì„œì—ì„œ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ì„œ í•„ìš”í•œ ë¶€ë¶„ì„ ë¹¨ë¦¬ ì°¾ì•„ë‚¼ ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë¯¸ë¦¬ ì—°ìŠµí•´ë‘ë©´ ì‹œí—˜ ì‹œê°„ì—ë„ ë°”ë¡œ ì°¾ì•„ë‚´ì„œ ë‹µì„ ì°¾ì•„ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê°œì¸ì ìœ¼ë¡œëŠ”, ì—…ë¬´ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ í™œìš©í•´ì„œ ì–´ëŠì •ë„ ì•Œê³  ìˆì—ˆì§€ë§Œ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì „ë°˜ì ì¸ ë¶€ë¶„ì„ ê²½í—˜í•´ë³¼ ìˆ˜ ìˆì–´ì„œ ë¬´ì²™ ì¢‹ì•˜ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì—…ë¬´ì—ì„œ ETCD ë°±ì—…ì„ í•´ë³¼ ê¸°íšŒê°€ ì—†ì—ˆëŠ”ë°, CKA ì‹œí—˜ì„ í†µí•´ì„œ ê²½í—˜í•´ë³¼ ìˆ˜ ìˆì–´ ì¢‹ì•˜ìŠµë‹ˆë‹¤.

## ê¿€íŒ

ë‹¤ìŒì€ ì œê°€ CKAë¥¼ ì¤€ë¹„í•˜ë©´ì„œ, ì‹œí—˜ ë³´ë©´ì„œ ì–»ê²Œ ëœ ê¿€íŒë“¤ì…ë‹ˆë‹¤.

* ìƒê°ë³´ë‹¤ ì–´ë µì§€ ì•Šë‹¤. ìš°ì„  ì‹œí—˜ ë‚ ì§œë¶€í„° ì •í•´ë†“ì.
  * CKA ì‹œí—˜ì€ ì¬ì‹œí—˜ ê¸°íšŒë¥¼ ì¤ë‹ˆë‹¤. ìš°ì„  ì‹œí—˜ ë‚ ì§œë¥¼ ì¡ì•„ë†“ëŠ”ê²Œ ì‹œí—˜ì„ ì¤€ë¹„í•˜ëŠ” ê°€ì¥ ë¹ ë¥¸ ë°©ë²•ì´ë¼ê³  ìƒê°í•©ë‹ˆë‹¤. ì¬ì‹œí—˜ ê¸°íšŒë„ ìˆìœ¼ë‹ˆ ìš°ì„  ë¶€ë”ªí˜€ë³´ë©´ í•©ê²© ì‹œê¸°ë¥¼ ê°€ì¥ ë‹¹ê¸¸ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
* ì‹œí—˜ í™˜ê²½ì— ìµìˆ™í•´ì§€ê¸°.
  * ì €ëŠ” ë§¥ í™˜ê²½ì´ì–´ì„œ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ë“±ì´ ì‹œí—˜ í™˜ê²½ê³¼ ë‹¬ëìŠµë‹ˆë‹¤. ë¯¸ë¦¬ `killer.sh` ì— ì ‘ì†í•´ì„œ ì‹œí—˜ í™˜ê²½ì—ì„œ ë¬¸ì œë¥¼ í•œ ë¬¸ì œ í’€ì–´ë³´ëŠ” ê²½í—˜ì´ ì‹œí—˜ ì‹œê°„ì— í° ë„ì›€ì´ ë©ë‹ˆë‹¤. ë˜ ë©”ëª¨ì¥ë„ ì‹œí—˜ í™˜ê²½ì—ì„œ í™œìš©í•˜ëŠ” ë©”ëª¨ì¥ì„ ë¯¸ë¦¬ ì¨ë³´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
* ì–´ë–¤ ë¬¸ì œë“¤ì´ ë‚˜ì˜¤ëŠ”ì§€ ë¯¸ë¦¬ íŒŒì•…í•´ë³´ê¸°.
  * `killer.sh` ì˜ CKA ì‹œë®¬ë ˆì´í„°ì—ì„œë„ ë¬¸ì œ ìœ í˜•ì´ ë¨¼ì € ë‚˜ì˜¤ê³ , Udemy ì˜ [CKA ê°•ì¢Œ](https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/), [ë”°ë°°ì”¨(ë”°ë¼í•˜ë©´ì„œ ë°°ìš°ëŠ” CKA)](https://www.youtube.com/watch?v=KdATmTulf7s&list=PLApuRlvrZKojqx9-wIvWP3MPtgy2B372f&ab_channel=TTABAE-LEARN) ë“±ì„ í†µí•´ ì‹œí—˜ì— ë‚˜ì˜¤ëŠ” ìœ í˜•ë“¤ì„ ë¯¸ë¦¬ ê²½í—˜í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ˆëŒ€ ì‹œê°„ìœ¼ë¡œ 20ì‹œê°„ ë‚´ì— ëª¨ë“  ìœ í˜•ì„ ê²½í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ë‚˜ë§Œì˜ ê²€ìƒ‰ í‚¤ì›Œë“œ ì •ë¦¬í•´ë‘ê¸°.
  * ì–´ë–¤ ë¬¸ì œë“¤ì´ ë‚˜ì˜¤ëŠ”ì§€ ì•Œì•˜ë‹¤ë©´ ê° ë¬¸ì œì— ë§ì¶° ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì •ë¦¬í•´ë‘ê³ , í•„ìš”í•œ ì‚¬í•­ë“¤ì´ ì–´ë””ì— ìˆëŠ”ì§€ ë¯¸ë¦¬ íŒŒì•…í•´ë‘ë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤. ì‹œí—˜ ì‹œê°„ì— ê³µì‹ ë¬¸ì„œëŠ” ì°¸ì¡°í•  ìˆ˜ ìˆê³ , ìì—°ìŠ¤ëŸ½ê²Œ ê²€ìƒ‰í•˜ë©´ì„œ í’€ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë³¸ì¸ì´ pvcë¥¼ ë§Œë“¤ ì¤„ ì•Œë”ë¼ë„, ì‹œí—˜ ì¤‘ì—ëŠ” ì–´ëŠ í˜ì´ì§€ì— pvcë¥¼ ë§Œë“œëŠ” ì˜ˆì‹œê°€ ìˆëŠ”ì§€ ë¯¸ë¦¬ ì•Œê³  ìˆì–´ì•¼ ì •ë‹µì„ ì‘ì„±í•˜ëŠ”ë° ì‹œê°„ì´ ë‹¨ì¶•ë©ë‹ˆë‹¤.


## ê²°ë¡ 

CKA ì‹œí—˜ì„ ì¤€ë¹„í•œ ê³¼ì •ê³¼ ê·¸ ì•ˆì—ì„œ ì•Œê²Œ ëœ ê¿€íŒë“¤ì„ ì •ë¦¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤. í˜¹ì‹œ CKAë¥¼ ì¤€ë¹„í•˜ëŠ” ë¶„ì´ ê³„ì‹œë‹¤ë©´, ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤! CKA ì˜ ì¤€ë¹„í•˜ì‹œê³ , ê¼­ í•©ê²©í•˜ê¸°ë¥¼ ë°”ë¼ê² ìŠµë‹ˆë‹¤ :-) 


## ë¬¸ì œ ìœ í˜•ê³¼ ì •ë¦¬ ë…¸íŠ¸ ê³µìœ 

```bash
# 1. ETCD Backup & Restore
# https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/
ssh k8s-master
sudo -i
tree /var/lib/etcd.db
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=<trusted-ca-file> --cert=<cert-file> --key=<key-file> \
  snapshot save /data/etcd-snapshot.db
ETCDCTL_API=3 etcdctl --data-dir /var/lib/etcd-previous.db snapshot restore /data/etcd-snapshot-previous.db
tree /var/lib/etcd-previous.db

vi /etc/kubernetes/manifests/etcd.yaml
# hostPath ê²½ë¡œ /var/lib/etcd-previous.db ë¡œ ë³€ê²½

# 2. Pod ìƒì„±í•˜ê¸°
k run eshop-main -n ecommerce --image=nginx:1.17 --env="DB=mysql"

# 3. Static Pod ìƒì„±í•˜ê¸°
# master component ë“¤ ëª¨ë‘ static pod ì„
# static pod ëŠ” ë…¸ë“œì˜ kubelet ì´ ì‹¤í–‰ì‹œí‚¤ê³ (API ë¥¼ íƒ€ì§€ ì•ŠìŒ.) etc/kubernetes/manifest/pod.yaml ì„

k run web --image=nginx --dry=run=client -o yaml  # ì´ ê²°ê³¼ ì €ì¥í•´ë‘ê³ .
-> ê²°ê³¼ ë‚˜ì˜´.
ssh hk8s-w
sudo -i
cat /var/lib/kubelet/config.yaml # staticpodPath ìœ„ì¹˜ í™•ì¸ ì´ë™.

# 4. Multi-container Pod ìƒì„±í•˜ê¸°
k run lab004 --image=nginx --dry-run=client -o yaml > multi.yaml
vi multi.yaml
redis, memcached ì¶”ê°€
k apply -f multi.yaml

# 5. Side-car Container Pod ì‹¤í–‰í•˜ê¸°
# Side car conatiner?
# ê¸°ì¡´ì— ì¡´ì¬í•˜ëŠ” íŒŒë“œ ë‚´ì—ì„œ k logs ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìŒ. ë‹¤ìš´ë¡œë“œ ë°›ê²Œ í•¨.
# https://kubernetes.io/docs/concepts/cluster-administration/logging/#sidecar-container-with-logging-agent
k get pod eshop-car-app
k get pod eshop-car-app -o yaml > eshop.yaml
vi eshop.yaml

# ì¶”ê°€.
  - name: sidecar
    image: busybox
    args: [/bin/sh, -c, 'tail -n+1 -F /var/log/car-app.log']
    volumeMounts:
    - name: varlog
      mountPath: /var/log
      
k apply -f eshop.yaml
k logs eshop-car-app -c sidecar

# 6. Deployment & Pod Scale
k config use-context k8s
k get namespaces devops
k get deployments.apps -n devops

k scale deployment eshop-order -n devops --replicas=5

# 6.2 create & scale up
k create deployment webserver --image=nginx:1.14 --replicas=2 --dry-run-client -o yaml
k create deployment webserver --image=nginx:1.14 --replicas=2 --dry-run-client -o yaml > webserver.yaml
# webserver.yaml ë¬¸ì œì— ë§ê²Œ ìˆ˜ì •.
k apply -f webserver.yaml
k get deployments -o yaml
k sacle deployment webserver --replicas=5

# 7. Rolling update & Roll Back
# https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment
# https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-a-deployment
k create deployment nginx-app --image=nginx:1.11.10-alpine --replicas=3 --dry-run=client -o yaml
k create deployment nginx-app --image=nginx:1.11.10-alpine --replicas=3

# update
kubectl set image deployment.v1.apps/nginx-app nginx=nginx:1.11.13-alpine --record

# rollback
kubectl rollout history deployment/nginx-app
kubectl rollout undo deployment/nginx-app

# 8. NodeSelector
# https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/
k get nodes -L disktype
k run eshop-store --image=nginx --dry-run=client -o yaml > eshop-store.yaml
# ìœ„ yaml ì— ì•„ë˜ ì¶”ê°€
  nodeSelector:
    disktype: ssd
k apply -f eshop-store.yaml

# 9. Node ê´€ë¦¬
k get nodes -o wide
k get pods -o wide

# schedule disalbe
k cordon k8s-worker1
k uncordon k8s-worker1

# 2ì— ìˆëŠ” ì• ë“¤ ë‹¤ ë‹¤ë¥¸ë°ë¡œ ì˜®ê¸°ê¸°, disable ë¨.
k drain k8s-worker2

# 10. Node ì •ë³´ ìˆ˜ì§‘
k get nodes | grep -i -w ready
k describe node .. | grep -i noschedule
k describe node .. | grep -i taint
k describe nodes grep -i -w ready wc -l > filePATH

# 11. Deployment & Export service
# https://kubernetes.io/docs/concepts/services-networking/service/#field-spec-ports
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app.kubernetes.io/name: proxy
spec:
  containers:
  - name: nginx
    image: nginx:stable
    ports:
      - containerPort: 80
        name: http-web-svc

---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: proxy
  ports:
  - name: name-of-service-port
    protocol: TCP
    port: 80
    targetPort: http-web-svc
---

k get deployment front-end
k get deployment front-end -o yaml > front-end.yaml
í¬íŠ¸ ì¶”ê°€, nodeport ì„œë¹„ìŠ¤ ì¶”ê°€.
curl <NODE_1>:31179

# 12. Pod Log
k get pods custom-app
k logs custom-app | grep "file not found" > /var/CKA...

# 13. CPU ì‚¬ìš©ëŸ‰ ë†’ì€ Pod ê²€ìƒ‰
k top nodes
k top pods -l name=overloaded-cpu --sort-by=cpu

# 14. init conatiner ë¥¼ í¬í•¨í•œ Pod ìš´ì˜
# https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#init-containers-in-use
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
  labels:
    app.kubernetes.io/name: MyApp
spec:
  containers:
  - name: myapp-container
    image: busybox:1.28
    command: ['sh', '-c', 'echo The app is running! && sleep 3600']
    volumeMounts:
    - name: workdir
      mountPath: "/workdir"
  initContainers:
  - name: init
    image: busybox:1.28
    command: ['sh', '-c', "touch /workdir/data.txt"]
    volumeMounts:
    - name: workdir
      mountPath: "/workdir"
  volumes:
  - name: workdir
    emptyDir: {}
    
# 15. NodePort ì„œë¹„ìŠ¤ ìƒì„±
# 11ë²ˆê³¼ ìœ ì‚¬. 11ë²ˆì€ ì„œë¹„ìŠ¤ì˜ targetPort containerì— ì íŒ í¬íŠ¸ ì´ë¦„ì´ì˜€ë‹¤.
# ì„œë¹„ìŠ¤ëŠ” ë³´í†µ labelì„ ê¸°ë°˜ìœ¼ë¡œ ìš´ì˜. ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ë“¤ì€ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì“°ì„
# íŒŸì´ ì™¸ë¶€ì™€ ì§ì ‘ í†µì‹ í•˜ë ¤ë©´ NodePort íƒ€ì…ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•¨.
# https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: NodePort
  selector:
    app: webui
  ports:
    - port: 80
      # By default and for convenience, the `targetPort` is set to
      # the same value as the `port` field.
      targetPort: 80
      # Optional field
      # By default and for convenience, the Kubernetes control plane
      # will allocate a port from a range (default: 30000-32767)
      nodePort: 32767
      
curl <NODE>:32767

# 16. ConfigMap ìš´ì˜
# https://kubernetes.io/docs/concepts/configuration/configmap/#configmaps-and-pods
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-config
  namespace: ckad
data:
  # property-like keys; each key maps to a simple value
  connection_string: "localhost:8"
  external_url: "cncf.io"

k run web-pod --image=nginx: --port=80 --dry-run=clint -o yaml

# https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#configure-all-key-value-pairs-in-a-configmap-as-container-environment-variables
# https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#populate-a-volume-with-data-stored-in-a-configmap

apiVersion: v1
kind: Pod
metadata:
  name: dapi-test-pod
  namespace: ckad
spec:
  containers:
    - name: test-container
      image: registry.k8s.io/busybox
      command: [ "/bin/sh", "-c", "env" ]
      envFrom:
      - configMapRef:
          name: web-config
          
          
# 17. Secret ìš´ì˜
# https://kubernetes.io/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret
k create secret generic super-secret --from-literal=password=secretpass

# 17.2 íŒŸ ìƒì„± volume mount
# https://kubernetes.io/docs/concepts/configuration/secret/#use-case-dotfiles-in-a-secret-volume
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-secrets-via-file
spec:
  volumes:
    - name: secret-apth
      secret:
        secretName: super-secret
  containers:
    - name: pod-secrets-via-file
      image: reids
      volumeMounts:
        - name: secret-path
          readOnly: true
          mountPath: "/secrets"
          
# 17.3 íŒŸ ìƒì„± í™˜ê²½ë³€ìˆ˜

apiVersion: v1
kind: Pod
metadata:
  name: pod-secrets-via-env
spec:
  containers:
  - name: pod-secrets-via-env
    image: redis
    env:
    - name: PASSWORD
      valueFrom:
        secretKeyRef:
          name: super-secret
          key: password
          
# 18. Ingress
# Ingress ëŠ” ë¼ìš°íŒ… ê·œì¹™ì— ë”°ë¼ ê°ê¸° ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•´ì¤Œ. ex. / ëŠ” main, /login ì€ login
# https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minimal-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx-example
  rules:
  - http:
      paths:
      - path: /testpath
        pathType: Prefix
        backend:
          service:
            name: test
            port:
              number: 80
              
k run nginx -n ingress-nginx --image=nginx --labels="app=hazelcast"
k expose -n ingress-nginx pod nginx --port=80 --target-port=80

k describe -n ingress-nginx svc nginx
# í•´ë‹¹ ëª…ë ¹ì–´ë¡œ ClusterIP, Endpoint í™•ì¸í•˜ê¸°

k get svc -n ingress-nginx
# í•´ë‹¹ ëª…ë ¹ì–´ë¡œ ì„œë¹„ìŠ¤ë“¤ì´ ëš«ë ¤ìˆëŠ” í¬íŠ¸ í™•ì¸í•˜ê¸° ì´ê±¸ë¡œ ì•„ë˜ ì„œë¹„ìŠ¤ì˜ í¬íŠ¸ ë²ˆí˜¸ ì ì–´ì¤Œ.

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  namespace: ingress-nginx
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    kubernetes.io/ingress.class: nginx
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx
            port:
              number: 80
      - path: /app
        pathType: Prefix
        backend:
          service:
            name: appjs-service
            port:
              number: 80
              
k get ingress -n ingress-nginx
k describe ingress app-ingress -n ingress-nginx
curl NODE_NAME:30080/
curl NODE_NAME:30080/app

# 19. PV ìƒì„±
# size, accessMode, storageClass(gp2, hdd ë“±), Reclaim(retain, recycle, delete ë“±), type ê°™ì€ê²ƒë„ ì •í•´ì¤„ ìˆ˜ ìˆìŒ.
# https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistent-volumes
# ì´í›„ pvcê°€ ìš”ì²­ë  ë•Œ, size, accessMode, storageClass ë¥¼ ë³´ê³  í• ë‹¹ì´ ê°€ëŠ¥í•œ ê²½ìš°ë¡œ í• ë‹¹í•´ì¤Œ. bound ë˜ì—ˆë‹¤ê³  í•¨.

apiVersion: v1
kind: PersistentVolume
metadata:
  name: app-config
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  storageClassName: az-c
  hostPath:
    path: /srv/app-config
    
# 20. PVC í• ë‹¹í•˜ëŠ” Pod ìš´ì˜

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-volume
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Mi
  storageClassName: app-hostpath-sc
  
  
apiVersion: v1
kind: Pod
metadata:
  name: web-server-pod
spec:
  containers:
    - name: web-server-pod
      image: nginx
      volumeMounts:
      - mountPath: "/usr//share/nginx/html"
        name: mypd
  volumes:
    - name: mypd
      persistentVolumeClaim:
        claimName: app-volume
        
k describe pods/web-server-pod

# 21. Check resource information
# sort ê´€ë ¨ cheat sheet í™•ì¸í•˜ê¸°
# https://kubernetes.io/docs/reference/kubectl/quick-reference/
# List Services Sorted by Name
kubectl get services --sort-by=.metadata.name
# List pods Sorted by Restart Count
kubectl get pods --sort-by='.status.containerStatuses[0].restartCount'
# List PersistentVolumes sorted by capacity
kubectl get pv --sort-by=.spec.capacity.storage

# 22. Kubernetes Upgrade
# https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/

# 23, 24 Trouble Shooting
# Docker, kubelet, cni, kube-proxy ë“¤ì´ ì˜ ì‘ë™í•˜ë©´ ë…¸ë“œëŠ” ì •ìƒì ìœ¼ë¡œ ì‘ë™í•¨.
systemctl status docker
systemctl enable --now docker
systemctl status kubelet
systemctl enable --now kubelet

# 25. User Role Binding
# ì¸ì¦. ì¿ ë²„ë„¤í‹°ìŠ¤ ê³„ì •(ì¸ì¦ì„œë¥¼ ê°€ì§€ê³  ìˆìŒ). ì¸ì¦ì„œë¥¼ í™•ì¸í•´ì„œ ê·¸ ê¶Œí•œì„ í™•ì¸í•¨. API ê°€ ê·¸ ì¸ì¦ì„ ìˆ˜í–‰í•¨.
# https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-example
# https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/
kubectl create role pod-role --verb=create,delete,watch,list,get --resource=pods
kubectl create rolebinding pod-rolebinding --role=pod-role --user=ckauser
kubectl config set-credentials ckauser --client-key=... --client-certificate=... --embed-certs=true
kubectl config set-context ckauser --cluster=kubernetes --user=ckauser

# 26. User Cluster Role Binding
# role ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— êµ­í•œ, ClusterRoleì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì œí•œì—†ì´ ê¶Œí•œì´ ìˆìŒ
kubectl create clusterrole app-clusterrole --verb=get,list,watch --resource=deployments,services
kubectl create clusterrolebinding app-clusterrole-binding --clusterrole=app:clusterrole --user=ckauser

# 27. ServiceAccount Role Binding
kubectl create role pod-role --verb=get,list,watch --resource=pods
kubectl create serviceaccount pod-access -n apps
k create rolebinding pod-rolebinding --role=pod-role --serviceaccount=apps:pod-access -n apps

# 28. ServiceAccount Cluster Role Binding
kubectl create serviceaccount cicd-token -n apps
kubectl create clusterrole pod-reader --verb=create --resource=deployments,daemonsets,statefulsets
kubectl create clusterrolebinding deployment-clusterrole-binding --clusterrole=deployment-clussterrole --serviceaccount=apps:cicd-token

# 29. Kube-DNS
# ClusterIP ì™€ Pod ë“¤ì´ ê°€ì§„ IP1(endpoint), IP2 ê°€ ì´ì–´ì§ˆ ìˆ˜ ì‡ìŒ.
# service ì´ë¦„ê³¼ ClusterIP ë¥¼ ì´ì–´ì£¼ëŠ”ê²Œ core DNS. ì´ì›í™”ë˜ì–´ìˆìŒ
# Pod IP ì— í•´ë‹¹í•˜ëŠ” ì´ë¦„ë„ ê¸°ì–µí•˜ê³  ìˆìŒ.
# core DNS ì˜ ë™ì‘ì›ë¦¬ë¥¼ ì•Œê³  ìˆìŠµë‹ˆê¹Œ?
# https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/
k run nginx-resolver --image=nginx
k expose pod nginx-resolver --name nginx-resolver-service --port=80 --target-port=80
k get pod nginx-resolver -o wide
# ìœ„ ëª…ë ¹ì–´ë¡œ POD IP í™•ì¸ ê°€ëŠ¥.
k get svc nginx-resolver-service -o wide
# ìœ„ ëª…ë ¹ì–´ë¡œ ClusterIP í™•ì¸ ê°€ëŠ¥.
k run --image=busybox --rm -it --restart=Never -- /bin/bash

# Service ì¡°íšŒ
# nslookup my-svc.defulat.svc.cluster.local
nslookup nginx-resolver-svc.default.svc.cluster.local
# Pods ì¡°íšŒ
# nslookup 172-17-0-3.default.pod.cluster.local
nslookup <POD_IP>.default.pod.cluster.local

# 30. Network Policy
# https://kubernetes.io/docs/concepts/services-networking/network-policies/#networkpolicy-resource
# íŒŸ(ë“¤)ì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ì…ë ¥ê³¼ ì¶œë ¥ì— ëŒ€í•œ ì •ì±…ì„. Ingress, egress 

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: test-network-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: db
  policyTypes:
  - Ingress
#   - Egress
  ingress:
  - from:
    - ipBlock:
        cidr: 172.17.0.0/16
#         except:
#         - 172.17.1.0/24
#     - namespaceSelector:
#         matchLabels:
#           project: myproject
#     - podSelector:
#         matchLabels:
#           role: frontend
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 80
#   egress:
#   - to:
#     - ipBlock:
#         cidr: 10.0.0.0/24
#     ports:
#     - protocol: TCP
#       port: 5978

```