안녕하세요. 오늘은 도커 컨테이너에서 GPU 관련 업무를 진행할 수 있도록 __cuda 10.2__ 와 __cudnn__ 이 설치된 컨테이너를 실행하는 방법에 대해 알아보도록 하겠습니다. 해당 글은 [여기](https://github.com/NVIDIA/nvidia-docker) 와 [여기](https://hub.docker.com/r/nvidia/cuda/tags) 그리고 [여기](https://docs.nvidia.com/dgx/nvidia-container-runtime-upgrade/index.html#:~:text=Use%20docker%20run%20with%20nvidia,file%20as%20the%20first%20entry.&text=You%20can%20then%20use%20docker%20run%20to%20run%20GPU%2Daccelerated%20containers) 를 참고했음을 알립니다. 이번에도 여러분의 삽질에 도움이 되기를 바랍니다!

### 예상독자

위 글을 읽는 독자는 아래 경험을 가지고 있다고 가정합니다.

* Docker 사용 경험
* Cuda를 설치하여 GPU를 활용한 네트워크 학습 경험

### nvidia 도커를 사용하여 GPU 사용이 가능한 컨테이너 실행

위 작업은 세가지로 이루어졌습니다.

1. nvidia docker 설치
2. docker runtime시에 nvidia-docker를 default로 추가
3. GPU 학습이 가능한 이미지를 만드는 도커파일 작성
4. 도커파일 실행(이미지 빌드) 및 컨테이너 실행

#### 1. nvidia docker 설치

```shell
$ ssh -NL localhost:7769:/var/run/docker.sock hooncheol.shin@182.@@@.@@@.@@@
```

* 내 로컬에서 사용하지 않는 포트와 원격 서버의 running container 정보를 연결시켜 주는 작업입니다.
* 제 경우에는 로컬의 `7769` 라는 포트 번호를 `182.@@@.@@@.@@@` 원격 서버의 ruuning docker 소켓(`/var/run/docker.sock`) 를 연결시켜 주었습니다.

#### 2. docker runtime시에 nvidia-docker를 default로 추가

```shell
$ DOCKER_HOST='tcp://localhost:7769'
```

* 로컬(저의 경우는 맥)내 $DOCKER_HOST 라는 환경변수에 내가 사용한 포트번호를 알려줍니다.
* VSCODE에서 저 포트를 타고 원격의 소켓에 접근할 수 있게됩니다.

#### 3. GPU 학습이 가능한 이미지를 만드는 도커파일 작성

```json
# in settings.json

{
	...,
	"docker.host": "tcp://localhost:7769"
}
```

* VSCode에도 `"docker.host"` 정보를 알려줍니다.

#### 4. 도커파일 실행(이미지 빌드) 및 컨테이너 실행

### Local VSCode에서 Remote Container에 attach!

이후에는 VSCode docker extension에서 원격의 container에 attach 할 수 있습니다.

>  ![remote_container](../imgs/remote_container.png)